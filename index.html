<html>
<head>
    <script src="./vendor/phaser.min.js"></script>
    <script src="./vendor/autobahn.min.js"></script>
</head>
<body>
<script>
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // имитация запаздывания входящих фреймов
    async function send(data) {
        let min = 50;
        let max = 500;
        let ms = Math.floor(Math.random() * (max - min) + min);
        await sleep(ms);
        return data;
    }

    let avg = {
        count: 0,
        sequence: [],
        val: function(){
            return Math.floor(this.sequence.reduce((a, b) => a + b, 0) / this.count);
        },
    };

    var connectionReciever = new autobahn.Connection({url: 'ws://127.0.0.1:8080/', realm: 'nexus.reaml1'});
    var connectionSender = new autobahn.Connection({url: 'ws://127.0.0.1:8080/', realm: 'nexus.reaml1'});

    connectionReciever.onopen = function (session) {

        session.subscribe('test', function(args) {

            send(args).then(function(args){
                let delay = frame - args[1];
                // console.log("Frame delay:", delay);
                avg.sequence.push(delay);
                avg.count++;
                console.log("Avg delay:", avg.val());
            });
        });
    };
    connectionReciever.open();


    connectionSender.onopen = function (session) {

        session.subscribe('test', function(args) {

            // send(args).then(function(args){
            //     console.log("Event for second:", args[0]);
            // });
        });
    };
    connectionSender.open();


    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    var game = new Phaser.Game(config);

    var frame = 0;

    function update (ms) {
        frame++;
        // раз в 50 мс с хорошей погрешностью
        // if (frame % 3 == 0) {
            connectionSender.session.publish('test', ['im sender', frame]); // + avg даст предсказание
        // }
    }

    function preload ()
    {
        this.load.setBaseURL('http://labs.phaser.io');

        this.load.image('sky', 'assets/skies/space3.png');
        this.load.image('logo', 'assets/sprites/phaser3-logo.png');
        this.load.image('red', 'assets/particles/red.png');
    }

    function create ()
    {
        this.add.image(400, 300, 'sky');

        var particles = this.add.particles('red');

        var emitter = particles.createEmitter({
            speed: 100,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        var logo = this.physics.add.image(400, 100, 'logo');

        logo.setVelocity(100, 200);
        logo.setBounce(1, 1);
        logo.setCollideWorldBounds(true);

        emitter.startFollow(logo);
    }
</script>
</body>
</html>