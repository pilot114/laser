<html>
<head>
    <script src="./vendor/phaser.min.js"></script>
    <script src="./vendor/autobahn.min.js"></script>
</head>
<body>
    <div id="info"></div>
<script>
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // имитация запаздывания входящих фреймов
    async function send(data) {
        let min = 50;
        let max = 500;
        let ms = Math.floor(Math.random() * (max - min) + min);
        await sleep(ms);
        return data;
    }

    let avg = {
        sequence: [],
        val: function(){
            return Math.floor(this.sequence.reduce((a, b) => a + b, 0) / this.sequence.length);
        }
    };
    let frame = 0;
    let incomingBytes = 0;

    let connectionReciever = new autobahn.Connection({url: 'ws://127.0.0.1:8080/', realm: 'nexus.reaml1'});
    let connectionSender = new autobahn.Connection({url: 'ws://127.0.0.1:8080/', realm: 'nexus.reaml1'});

    connectionReciever.onopen = function (session, details) {

        // инжектим в сокет свои обработчик для получение размера входящих фреймов
        let soc = connectionReciever.session._socket;
        let oldHandler = soc.onmessage;
        soc.onmessage = function(event){
            oldHandler(event);
            incomingBytes += JSON.stringify(event).length;
        };

        // https://github.com/crossbario/autobahn-js/blob/master/doc/reference.md#session-properties
        session.subscribe('test', function(args) {

            send(args).then(function(args){
                let delay = frame - args[1];
                avg.sequence.push(delay);
            });
        });
    };
    connectionReciever.open();


    connectionSender.onopen = function (session) {

        session.subscribe('test', function(args) {

            // send(args).then(function(args){
            //     console.log("Event for second:", args[0]);
            // });
        });
    };
    connectionSender.open();


    let config = {
        type: Phaser.AUTO,
        width: 1,
        height: 1,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    let game = new Phaser.Game(config);

    function update (ms) {
        frame++;
        // раз в 50 мс с хорошей погрешностью
        // if (frame % 3 == 0) {
            connectionSender.session.publish('test', ['im sender', frame]); // + avg даст предсказание
        // }

        //
        document.getElementById('info').innerHTML = JSON.stringify({
            'frame' : frame,
            'incomingBytes' : incomingBytes,
            'avgFrameDelay' : avg.val(),
        })
    }

    function preload ()
    {
        this.load.setBaseURL('http://labs.phaser.io');

        this.load.image('sky', 'assets/skies/space3.png');
        this.load.image('logo', 'assets/sprites/phaser3-logo.png');
        this.load.image('red', 'assets/particles/red.png');
    }

    function create ()
    {
        this.add.image(400, 300, 'sky');

        var particles = this.add.particles('red');

        var emitter = particles.createEmitter({
            speed: 100,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        var logo = this.physics.add.image(400, 100, 'logo');

        logo.setVelocity(100, 200);
        logo.setBounce(1, 1);
        logo.setCollideWorldBounds(true);

        emitter.startFollow(logo);
    }
</script>
</body>
</html>